<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title || 'UsinaSoft' %></title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- FontAwesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- UsinaSoft Custom CSS -->
    <link rel="stylesheet" href="/css/usinasoft-bootstrap.css" />
    <link rel="stylesheet" href="/css/atividades.css" />
  </head>

  <body>
    <%- include('partials/header', { user: user, showNav: true, currentPage:
    'atividades' }) %>

    <main class="main-content">
      <div class="activities-container">
        <!-- Page Header -->
        <div class="activities-header">
          <div class="header-content">
            <h1 class="page-title">Controle de Atividades</h1>
            <p class="page-description">
              Gerencie todas as atividades de produção em um único lugar
            </p>
          </div>
        </div>

        <!-- Error/Success Alerts -->
        <% if (error) { %>
        <div
          class="alert alert-danger alert-dismissible fade show"
          role="alert"
        >
          <i class="fas fa-exclamation-circle"></i>
          <%= error %>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
          ></button>
        </div>
        <% } %>

        <!-- Stats Cards -->
        <div class="stats-row">
          <div class="stat-card stat-card-primary">
            <div class="stat-icon">
              <i class="fas fa-tasks"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="total-activities">0</div>
              <div class="stat-label">Total de Atividades</div>
            </div>
          </div>

          <div class="stat-card stat-card-info">
            <div class="stat-icon">
              <i class="fas fa-hourglass-start"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="pending-activities">0</div>
              <div class="stat-label">Na Fila</div>
            </div>
          </div>

          <div class="stat-card stat-card-warning">
            <div class="stat-icon">
              <i class="fas fa-spinner"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="in-progress-activities">0</div>
              <div class="stat-label">Em Andamento</div>
            </div>
          </div>

          <div class="stat-card stat-card-success">
            <div class="stat-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="completed-activities">0</div>
              <div class="stat-label">Concluídas</div>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="content-wrapper">
          <!-- Sidebar Filters -->
          <aside class="filters-sidebar">
            <div class="filter-card">
              <div class="filter-header">
                <h3 class="filter-title">
                  <i class="fas fa-filter"></i> Filtros
                </h3>
              </div>

              <!-- Search -->
              <div class="filter-group">
                <label class="filter-label">Buscar por Título</label>
                <input
                  type="text"
                  id="search-titulo"
                  class="filter-input"
                  placeholder="Digite o título..."
                />
              </div>

              <!-- Status Filter -->
              <div class="filter-group">
                <label class="filter-label">Status</label>
                <div class="filter-checkboxes">
                  <label class="filter-checkbox">
                    <input
                      type="checkbox"
                      class="status-filter"
                      value="aberta"
                      checked
                    />
                    <span class="checkbox-label">Na Fila</span>
                  </label>
                  <label class="filter-checkbox">
                    <input
                      type="checkbox"
                      class="status-filter"
                      value="em_andamento"
                      checked
                    />
                    <span class="checkbox-label">Em Andamento</span>
                  </label>
                  <label class="filter-checkbox">
                    <input
                      type="checkbox"
                      class="status-filter"
                      value="concluida"
                      checked
                    />
                    <span class="checkbox-label">Concluída</span>
                  </label>
                  <label class="filter-checkbox">
                    <input
                      type="checkbox"
                      class="status-filter"
                      value="pausada"
                    />
                    <span class="checkbox-label">Pausada</span>
                  </label>
                  <label class="filter-checkbox">
                    <input
                      type="checkbox"
                      class="status-filter"
                      value="cancelada"
                    />
                    <span class="checkbox-label">Cancelada</span>
                  </label>
                </div>
              </div>

              <!-- Priority Filter -->
              <div class="filter-group">
                <label class="filter-label">Prioridade</label>
                <div class="filter-checkboxes">
                  <label class="filter-checkbox">
                    <input
                      type="checkbox"
                      class="priority-filter"
                      value="alta"
                      checked
                    />
                    <span class="checkbox-label">Alta</span>
                  </label>
                  <label class="filter-checkbox">
                    <input
                      type="checkbox"
                      class="priority-filter"
                      value="media"
                      checked
                    />
                    <span class="checkbox-label">Média</span>
                  </label>
                  <label class="filter-checkbox">
                    <input
                      type="checkbox"
                      class="priority-filter"
                      value="baixa"
                      checked
                    />
                    <span class="checkbox-label">Baixa</span>
                  </label>
                </div>
              </div>

              <!-- Date Range Filter -->
              <div class="filter-group">
                <label class="filter-label">Data de Início</label>
                <input
                  type="date"
                  id="filter-date-start"
                  class="filter-input"
                />
              </div>

              <div class="filter-group">
                <label class="filter-label">Data de Fim</label>
                <input type="date" id="filter-date-end" class="filter-input" />
              </div>

              <!-- Clear Filters Button -->
              <button
                class="btn btn-outline-danger w-100"
                onclick="limparFiltros()"
              >
                <i class="fas fa-times"></i> Limpar Filtros
              </button>
            </div>
          </aside>

          <!-- Main Activities Section -->
          <section class="activities-main">
            <!-- View Toggle -->
            <div class="view-toggle">
              <button
                class="toggle-btn active"
                onclick="mudarView('cards')"
                data-view="cards"
              >
                <i class="fas fa-th"></i> Cards
              </button>
              <button
                class="toggle-btn"
                onclick="mudarView('table')"
                data-view="table"
              >
                <i class="fas fa-list"></i> Tabela
              </button>
              <span class="results-counter">
                <i class="fas fa-info-circle"></i>
                <span id="results-count">0</span>
                resultado(s)
              </span>
            </div>

            <!-- Cards View -->
            <div class="activities-grid" id="cards-view">
              <% atividades.forEach((atividade, index)=> { %>
              <div
                class="activity-card"
                data-id="<%= atividade.id %>"
                data-status="<%= atividade.status %>"
                data-prioridade="<%= atividade.prioridade %>"
              >
                <div class="card-header-section">
                  <div class="card-header-info">
                    <h3 class="card-title"><%= atividade.titulo %></h3>
                    <p class="card-description">
                      <%= atividade.descricao || 'Sem descrição' %>
                    </p>
                  </div>
                  <div class="card-status-badge">
                    <span class="status-badge status-<%= atividade.status %>">
                      <i class="<%= getStatusIcon(atividade.status) %>"></i>
                      <%= getStatusLabel(atividade.status) %>
                    </span>
                  </div>
                </div>

                <div class="card-body-section">
                  <div class="info-row">
                    <div class="info-item">
                      <span class="info-label">
                        <i class="fas fa-user"></i> Responsável
                      </span>
                      <span class="info-value">
                        <%= atividade.responsavel_nome %>
                      </span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">
                        <i class="fas fa-flag"></i> Prioridade
                      </span>
                      <span
                        class="info-value priority-<%= atividade.prioridade %>"
                      >
                        <%= atividade.prioridade || 'Normal' %>
                      </span>
                    </div>
                  </div>

                  <div class="info-row">
                    <div class="info-item">
                      <span class="info-label">
                        <i class="fas fa-calendar-alt"></i> Início
                      </span>
                      <span class="info-value">
                        <%= atividade.data_inicio_formatada %>
                      </span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">
                        <i class="fas fa-calendar-check"></i> Fim
                      </span>
                      <span class="info-value">
                        <%= atividade.data_fim_formatada %>
                      </span>
                    </div>
                  </div>

                  <% if (atividade.ordem) { %>
                  <div class="info-row">
                    <div class="info-item">
                      <span class="info-label">
                        <i class="fas fa-cube"></i> Ordem ID
                      </span>
                      <span class="info-value">#<%= atividade.ordem %></span>
                    </div>
                  </div>
                  <% } %>
                </div>

                <div class="card-footer-section">
                  <% if (atividade.status !=='concluida' && atividade.status
                  !=='cancelada' ) { %>
                  <button
                    class="btn btn-action btn-primary"
                    onclick="verDetalhes(<%= atividade.id %>)"
                  >
                    <i class="fas fa-eye"></i> Detalhes
                  </button>
                  <button
                    class="btn btn-action btn-secondary"
                    onclick="editarAtividade(<%= atividade.id %>)"
                  >
                    <i class="fas fa-edit"></i> Editar
                  </button>
                  <% } %>
                  <button
                    class="btn btn-action btn-outline-danger"
                    onclick="removerAtividade(<%= atividade.id %>)"
                  >
                    <i class="fas fa-trash"></i> Remover
                  </button>
                </div>
              </div>
              <% }); %> <% if (atividades.length===0) { %>
              <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>Nenhuma atividade encontrada</h3>
                <p>Comece criando uma nova atividade</p>
              </div>
              <% } %>
            </div>

            <!-- Table View -->
            <div class="activities-table" id="table-view" style="display: none">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Título</th>
                    <th>Status</th>
                    <th>Prioridade</th>
                    <th>Responsável</th>
                    <th>Início</th>
                    <th>Fim</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <% atividades.forEach(atividade=> { %>
                  <tr
                    class="activity-row"
                    data-id="<%= atividade.id %>"
                    data-status="<%= atividade.status %>"
                    data-prioridade="<%= atividade.prioridade %>"
                  >
                    <td>
                      <strong> <%= atividade.titulo %> </strong>
                      <% if (atividade.descricao) { %>
                      <br /><small class="text-muted">
                        <%= atividade.descricao %>
                      </small>
                      <% } %>
                    </td>
                    <td>
                      <span class="status-badge status-<%= atividade.status %>">
                        <i class="<%= getStatusIcon(atividade.status) %>"></i>
                        <%= getStatusLabel(atividade.status) %>
                      </span>
                    </td>
                    <td>
                      <span
                        class="priority-badge priority-<%= atividade.prioridade %>"
                      >
                        <%= atividade.prioridade || 'Normal' %>
                      </span>
                    </td>
                    <td><%= atividade.responsavel_nome %></td>
                    <td><%= atividade.data_inicio_formatada %></td>
                    <td><%= atividade.data_fim_formatada %></td>
                    <td>
                      <div class="action-buttons">
                        <button
                          class="btn btn-sm btn-primary"
                          onclick="verDetalhes(<%= atividade.id %>)"
                          title="Ver detalhes"
                        >
                          <i class="fas fa-eye"></i>
                        </button>
                        <% if (atividade.status !=='concluida' &&
                        atividade.status !=='cancelada' ) { %>
                        <button
                          class="btn btn-sm btn-secondary"
                          onclick="editarAtividade(<%= atividade.id %>)"
                          title="Editar"
                        >
                          <i class="fas fa-edit"></i>
                        </button>
                        <% } %>
                        <button
                          class="btn btn-sm btn-outline-danger"
                          onclick="removerAtividade(<%= atividade.id %>)"
                          title="Remover"
                        >
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>

              <% if (atividades.length===0) { %>
              <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>Nenhuma atividade encontrada</h3>
                <p>Comece criando uma nova atividade</p>
              </div>
              <% } %>
            </div>
          </section>
        </div>
      </div>
    </main>

    <%- include('partials/footer') %>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/main.js"></script>

    <script>
      const atividadesData = <%- JSON.stringify(atividades) %>;
      console.log('Dados de atividades recebidos:', atividadesData);
      if (atividadesData && atividadesData.length > 0) {
          console.log('Primeira atividade:', atividadesData[0]);
          console.log('Status da primeira atividade:', atividadesData[0].status);
      }

      // Initialize stats
      function atualizarEstatisticas() {
          const total = atividadesData.length;
          const emFila = atividadesData.filter(a => a.status === 'aberta').length;
          const emAndamento = atividadesData.filter(a => a.status === 'em_andamento').length;
          const concluidas = atividadesData.filter(a => a.status === 'concluida').length;

          document.getElementById('total-activities').textContent = total;
          document.getElementById('pending-activities').textContent = emFila;
          document.getElementById('in-progress-activities').textContent = emAndamento;
          document.getElementById('completed-activities').textContent = concluidas;
      }

      // Helper function to convert numeric priority to string
      function getPrioridadeLabel(numericPriority) {
          if (!numericPriority) return null;
          if (numericPriority >= 4) return 'alta';
          if (numericPriority >= 2) return 'media';
          if (numericPriority >= 1) return 'baixa';
          return null;
      }

      // Filter activities
      function filtrarAtividades() {
          const searchTitulo = document.getElementById('search-titulo').value.toLowerCase();
          const statusCheckboxes = document.querySelectorAll('.status-filter:checked');
          const statusSelecionados = Array.from(statusCheckboxes).map(cb => cb.value);
          const prioridades = Array.from(document.querySelectorAll('.priority-filter:checked')).map(cb => cb.value);
          const dataInicio = document.getElementById('filter-date-start').value;
          const dataFim = document.getElementById('filter-date-end').value;

          let atividadesFiltradas = atividadesData.filter(atividade => {
              const matchTitulo = !searchTitulo || atividade.titulo.toLowerCase().includes(searchTitulo);
              
              // Se nenhum status foi selecionado, mostrar nenhum; caso contrário, verificar se o status está na lista
              const matchStatus = statusSelecionados.length > 0 && statusSelecionados.includes(atividade.status);
              
              // Converter prioridade numérica para string e verificar
              const prioridadeLabel = getPrioridadeLabel(atividade.prioridade);
              const matchPrioridade = prioridades.length > 0 && prioridadeLabel && prioridades.includes(prioridadeLabel);
              
              const matchDataInicio = !dataInicio || (atividade.data_inicio && atividade.data_inicio >= dataInicio);
              const matchDataFim = !dataFim || (atividade.data_fim && atividade.data_fim <= dataFim);

              return matchTitulo && matchStatus && matchPrioridade && matchDataInicio && matchDataFim;
          });

          // Update cards view
          const cardsView = document.getElementById('cards-view');
          cardsView.querySelectorAll('.activity-card').forEach(card => {
              const atividade = atividadesData.find(a => a.id == card.dataset.id);
              card.style.display = atividadesFiltradas.includes(atividade) ? '' : 'none';
          });

          // Update table view
          const tableView = document.getElementById('table-view');
          tableView.querySelectorAll('.activity-row').forEach(row => {
              const atividade = atividadesData.find(a => a.id == row.dataset.id);
              row.style.display = atividadesFiltradas.includes(atividade) ? '' : 'none';
          });

          document.getElementById('results-count').textContent = atividadesFiltradas.length;
      }

      // Clear filters
      function limparFiltros() {
          document.getElementById('search-titulo').value = '';
          document.getElementById('filter-date-start').value = '';
          document.getElementById('filter-date-end').value = '';

          document.querySelectorAll('.status-filter').forEach(cb => cb.checked = true);
          document.querySelectorAll('.priority-filter').forEach(cb => cb.checked = true);

          filtrarAtividades();
      }

      // Change view
      function mudarView(view) {
          document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelector(`[data-view="${view}"]`).classList.add('active');

          const cardsView = document.getElementById('cards-view');
          const tableView = document.getElementById('table-view');

          if (view === 'cards') {
              cardsView.style.display = '';
              tableView.style.display = 'none';
          } else {
              cardsView.style.display = 'none';
              tableView.style.display = '';
          }
      }

      // View details
      function verDetalhes(id) {
          const atividade = atividadesData.find(a => a.id === id);
          if (atividade) {
              alert(`Detalhes da Atividade:\n\nTítulo: ${atividade.titulo}\nStatus: ${atividade.status}\nPrioridade: ${atividade.prioridade}`);
          }
      }

      // Edit activity
      function editarAtividade(id) {
          const atividade = atividadesData.find(a => a.id === id);
          if (atividade) {
              alert(`Editar Atividade: ${atividade.titulo}\n\nFuncionalidade em desenvolvimento...`);
          }
      }

      // Remove activity
      function removerAtividade(id) {
          if (confirm('Tem certeza que deseja remover esta atividade?')) {
              console.log(`Removendo atividade ${id}`);
              // Implementar chamada à API
          }
      }

      // Event listeners
      document.getElementById('search-titulo').addEventListener('input', filtrarAtividades);
      document.querySelectorAll('.status-filter').forEach(cb => cb.addEventListener('change', filtrarAtividades));
      document.querySelectorAll('.priority-filter').forEach(cb => cb.addEventListener('change', filtrarAtividades));
      document.getElementById('filter-date-start').addEventListener('change', filtrarAtividades);
      document.getElementById('filter-date-end').addEventListener('change', filtrarAtividades);

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
          atualizarEstatisticas();
          filtrarAtividades();
      });
    </script>
  </body>
</html>
