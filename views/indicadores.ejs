<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title || 'UsinaSoft' %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/usinasoft-bootstrap.css" />
    <link rel="stylesheet" href="/css/indicadores.css" />
  </head>

  <body>
    <%- include('partials/header', { user: user, showNav: true, currentPage:
    'indicadores' }) %>

    <main class="main-content">
      <div class="page-container">
        <div class="page-header">
          <div class="header-content">
            <h1>
              <i class="fas fa-chart-line header-icon"></i>
              Indicadores de Produção
            </h1>
            <p>Visualize métricas consolidadas das ordens de produção.</p>
          </div>
          <% if (indicadores && indicadores.periodo) { %>
          <div class="header-period">
            <span>
              <i class="fas fa-calendar-alt"></i>
              Período analisado:
              <strong><%= indicadores.periodo.start %></strong>
              até
              <strong><%= indicadores.periodo.end %></strong>
              (<%= indicadores.periodo.date_field === 'created_at'
              ? 'Data de criação'
              : 'Data fim prevista' %>)
            </span>
          </div>
          <% } %>
        </div>

        <div class="content-wrapper">
          <div class="filter-card">
            <h2 class="filter-title">
              <i class="fas fa-filter"></i>
              Filtrar Período
            </h2>
            <form id="filter-form" method="get" action="/indicadores">
              <div class="filter-grid">
                <div class="form-group">
                  <label for="start">Data Início</label>
                  <input
                    type="date"
                    id="start"
                    name="start"
                    value="<%= (query && query.start) || '' %>"
                  />
                </div>
                <div class="form-group">
                  <label for="end">Data Fim</label>
                  <input
                    type="date"
                    id="end"
                    name="end"
                    value="<%= (query && query.end) || '' %>"
                  />
                </div>
                <div class="form-group">
                  <label for="date_field">Campo de Data</label>
                  <select id="date_field" name="date_field">
                    <option
                      value="created_at"
                      <%= (query && query.date_field) === 'created_at' || !query?.date_field
                      ? 'selected'
                      : '' %>
                    >
                      Data de criação
                    </option>
                    <option
                      value="updated_at"
                      <%= (query && query.date_field) === 'updated_at'
                      ? 'selected'
                      : '' %>
                    >
                      Data de atualização
                    </option>
                  </select>
                </div>
              </div>
              <div class="filter-actions">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-search"></i>
                  Aplicar
                </button>
                <a href="/indicadores" class="btn btn-secondary">
                  <i class="fas fa-undo"></i>
                  Limpar
                </a>
              </div>
            </form>
          </div>

          <% if (error) { %>
          <div class="alert alert-danger"><%= error %></div>
          <% } else if (!indicadores) { %>
          <div class="alert alert-info">
            Nenhum indicador disponível para o período selecionado.
          </div>
          <% } else { %>
          <!-- Stats OPs -->
          <div class="stats-section">
            <h3 class="section-title">
              <i class="fas fa-file-alt"></i>
              Ordens de Produção
            </h3>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-icon total-icon">
                  <i class="fas fa-layer-group"></i>
                </div>
                <div class="stat-info">
                  <h4>Total de OPs</h4>
                  <p><%= indicadores.total || 0 %></p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon fila-icon">
                  <i class="fas fa-folder-open"></i>
                </div>
                <div class="stat-info">
                  <h4>Abertas</h4>
                  <p><%= indicadores.por_status?.aberta || 0 %></p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon andamento-icon">
                  <i class="fas fa-cogs"></i>
                </div>
                <div class="stat-info">
                  <h4>Em Andamento</h4>
                  <p><%= indicadores.por_status?.em_andamento || 0 %></p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon concluida-icon">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                  <h4>Concluídas</h4>
                  <p><%= indicadores.por_status?.concluida || 0 %></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Stats Peças -->
          <div class="stats-section mt-4">
            <h3 class="section-title">
              <i class="fas fa-wrench"></i>
              Peças
            </h3>
            <div class="stats-grid">
              <% const agrupado = indicadores.agrupado || {}; %>
              <div class="stat-card">
                <div class="stat-icon total-icon">
                  <i class="fas fa-cubes"></i>
                </div>
                <div class="stat-info">
                  <h4>Total de Peças</h4>
                  <p><%= indicadores.pecas?.total || 0 %></p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon fila-icon">
                  <i class="fas fa-hourglass-start"></i>
                </div>
                <div class="stat-info">
                  <h4>Em Fila</h4>
                  <p><%= agrupado.emFila || 0 %></p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon andamento-icon">
                  <i class="fas fa-spinner"></i>
                </div>
                <div class="stat-info">
                  <h4>Em Andamento</h4>
                  <p><%= agrupado.emAndamento || 0 %></p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon concluida-icon">
                  <i class="fas fa-check-double"></i>
                </div>
                <div class="stat-info">
                  <h4>Concluídas</h4>
                  <p><%= agrupado.concluidas || 0 %></p>
                </div>
              </div>
            </div>
          </div>

          <div class="charts-section">
            <div class="chart-card">
              <h3>Distribuição por Status</h3>
              <div class="chart-container">
                <canvas
                  id="status-chart"
                  data-status='<%- JSON.stringify((indicadores && indicadores.por_status) || {}) %>'
                  data-has-status="<%= indicadores && indicadores.por_status ? 'true' : 'false' %>"
                ></canvas>
              </div>
            </div>
            <div class="table-card">
              <h3>Detalhes por Status</h3>
              <table class="details-table">
                <thead>
                  <tr>
                    <th>Status</th>
                    <th>Quantidade</th>
                    <th>Percentual</th>
                  </tr>
                </thead>
                <tbody>
                  <% const statusDetalhado = indicadores.por_status || {}; %>
                  <% const totalOps = Object.values(statusDetalhado).reduce(
                  (acc, value) => acc + value, 0
                  ); %>
                  <% const statusMap = {
                    aberta: { label: 'Aberta', icon: 'fa-folder-open' },
                    em_andamento: { label: 'Em Andamento', icon: 'fa-cogs' },
                    pausada: { label: 'Pausada', icon: 'fa-pause-circle' },
                    concluida: { label: 'Concluída', icon: 'fa-check-circle' },
                    cancelada: { label: 'Cancelada', icon: 'fa-times-circle' },
                  }; %>
                  <% Object.keys(statusMap).forEach((status) => { %>
                  <tr>
                    <td>
                      <i class="fas <%= statusMap[status].icon %>"></i>
                      <%= statusMap[status].label %>
                    </td>
                    <td><%= statusDetalhado[status] || 0 %></td>
                    <td>
                      <%= totalOps > 0
                        ? (((statusDetalhado[status] || 0) / totalOps) * 100
                          ).toFixed(1) + '%'
                        : '0.0%'
                      %>
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
          <% } %>
        </div>
      </div>
    </main>

    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const chartElement = document.getElementById('status-chart');
        if (!chartElement) return;

        const hasStatusData = chartElement.dataset.hasStatus === 'true';
        let statusData = {};

        try {
          statusData = JSON.parse(chartElement.dataset.status || '{}');
        } catch (err) {
          statusData = {};
        }

        if (!hasStatusData || !Object.keys(statusData).length) return;

        const labelsMap = {
          aberta: 'Aberta',
          em_andamento: 'Em Andamento',
          pausada: 'Pausada',
          concluida: 'Concluída',
          cancelada: 'Cancelada',
        };

        const labels = Object.keys(labelsMap);
        const dataSet = labels.map((key) => statusData[key] || 0);

        new Chart(chartElement, {
          type: 'doughnut',
          data: {
            labels: labels.map((key) => labelsMap[key]),
            datasets: [
              {
                data: dataSet,
                backgroundColor: [
                  '#3498db',
                  '#ff9f43',
                  '#f1c40f',
                  '#2ecc71',
                  '#e74c3c',
                ],
                borderColor: '#FFF',
                borderWidth: 2,
                hoverOffset: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: {
                  color: '#333',
                  boxWidth: 16,
                },
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const total = context.dataset.data.reduce(
                      (acc, value) => acc + value,
                      0
                    );
                    const value = context.parsed;
                    const percentage =
                      total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `${context.label}: ${value} (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      });
    </script>
  </body>
</html>
